#!/bin/sh

usage(){
	echo >&2 "Usage: $0 [--use-ps]"
	exit 1
}

trace_tool(){
	sed '/TRACE_TOOL/s/.*/#define TRACE_TOOL "$1"/' config.h > config.h2
	mv config.h2 config.h
}

config(){
	echo "$@" >> config.mk
}

use_ps=0
for arg in $@
do
	case "$arg" in
		--use-ps)
			use_ps=1
			;;
		*)
			usage
			;;
	esac
done

set -e
rm -f config.mk

arch=`uname -s`

case $arch in
	FreeBSD)
		config "LDFLAGS += -lkvm"
		trace_tool ktrace
		;;
	Linux)
		config "CFLAGS += -D_POSIX_SOURCE -D_BSD_SOURCE"
		trace_tool strace
		;;
	*)
		if test $use_ps -eq 0
		then
			echo "unregonised platform ($arch)" >&2
			echo "Using \`ps\` parser"
			use_ps=1
		fi
		;;
esac

if test $use_ps -ne 0
then config "CFLAGS += -DMACHINE_PS"
fi

echo Configured for $arch
